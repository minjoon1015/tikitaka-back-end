-- 테이블 생성
CREATE TABLE user (
  id            VARCHAR(50)  NOT NULL,
  name          VARCHAR(50)  NOT NULL,
  password      VARCHAR(100) NOT NULL,
  profile_image TEXT         NULL,
  PRIMARY KEY (id)
) COMMENT='유저';

CREATE TABLE alarm (
  id           INT AUTO_INCREMENT NOT NULL,
  user_id      VARCHAR(50) NOT NULL,
  alarm_type   VARCHAR(50) NOT NULL,
  reference_id VARCHAR(50) NOT NULL,
  create_at    DATETIME    NOT NULL,
  PRIMARY KEY (id)
) COMMENT='알림';

CREATE TABLE chat_room (
  id                INT AUTO_INCREMENT NOT NULL,
  user_id           VARCHAR(50) NOT NULL,
  title             VARCHAR(50) NOT NULL,
  profile_image     TEXT        NULL,
  last_message_time DATETIME    NULL,
  last_message      TEXT        NULL,
  PRIMARY KEY (id)
) COMMENT='채팅방';

CREATE TABLE chat_room_participant (
  user_id      VARCHAR(50) NOT NULL,
  chat_room_id INT         NOT NULL,
  PRIMARY KEY (user_id, chat_room_id)
) COMMENT='채팅 참여자';

CREATE TABLE chat_message (
  id           INT AUTO_INCREMENT NOT NULL,
  user_id      VARCHAR(50) NOT NULL,
  chat_room_id INT         NOT NULL,
  message      TEXT        NULL,
  create_at    DATETIME    NULL,
  PRIMARY KEY (id)
) COMMENT='채팅메시지';

CREATE TABLE chat_last_read (
  user_id      VARCHAR(50) NOT NULL,
  chat_room_id INT         NOT NULL,
  message_id   INT         NOT NULL,
  PRIMARY KEY (user_id, chat_room_id)
);

CREATE TABLE friend (
  id          INT AUTO_INCREMENT NOT NULL,
  sender_id   VARCHAR(50) NOT NULL,
  receiver_id VARCHAR(50) NOT NULL,
  status      VARCHAR(50) NOT NULL,
  create_at   DATETIME    NOT NULL,
  PRIMARY KEY (id),
  UNIQUE KEY uq_friend_pair (sender_id, receiver_id)
) COMMENT='친구';

-- 외래키 설정
ALTER TABLE chat_room
  ADD CONSTRAINT FK_user_TO_chat_room
    FOREIGN KEY (user_id) REFERENCES user(id)
    ON DELETE CASCADE
    ON UPDATE CASCADE;

ALTER TABLE chat_room_participant
  ADD CONSTRAINT FK_user_TO_chat_room_participant
    FOREIGN KEY (user_id) REFERENCES user(id)
    ON DELETE CASCADE
    ON UPDATE CASCADE;

ALTER TABLE chat_room_participant
  ADD CONSTRAINT FK_chat_room_TO_chat_room_participant
    FOREIGN KEY (chat_room_id) REFERENCES chat_room(id)
    ON DELETE CASCADE
    ON UPDATE CASCADE;

ALTER TABLE chat_message
  ADD CONSTRAINT FK_user_TO_chat_message
    FOREIGN KEY (user_id) REFERENCES user(id)
    ON DELETE CASCADE
    ON UPDATE CASCADE;

ALTER TABLE chat_message
  ADD CONSTRAINT FK_chat_room_TO_chat_message
    FOREIGN KEY (chat_room_id) REFERENCES chat_room(id)
    ON DELETE CASCADE
    ON UPDATE CASCADE;

ALTER TABLE chat_last_read
  ADD CONSTRAINT FK_user_TO_chat_last_read
    FOREIGN KEY (user_id) REFERENCES user(id)
    ON DELETE CASCADE
    ON UPDATE CASCADE;

ALTER TABLE chat_last_read
  ADD CONSTRAINT FK_chat_room_TO_chat_last_read
    FOREIGN KEY (chat_room_id) REFERENCES chat_room(id)
    ON DELETE CASCADE
    ON UPDATE CASCADE;

ALTER TABLE alarm
  ADD CONSTRAINT FK_user_TO_alarm
    FOREIGN KEY (user_id) REFERENCES user(id)
    ON DELETE CASCADE
    ON UPDATE CASCADE;

ALTER TABLE friend
  ADD CONSTRAINT FK_user_TO_friend
    FOREIGN KEY (sender_id) REFERENCES user(id)
    ON DELETE CASCADE
    ON UPDATE CASCADE;

ALTER TABLE friend
  ADD CONSTRAINT FK_user_TO_friend1
    FOREIGN KEY (receiver_id) REFERENCES user(id)
    ON DELETE CASCADE
    ON UPDATE CASCADE;
